import groovy.transform.Field

//static param
@Field charset = "utf-8"
@Field rootPackageName = "com.proper.enterprise"
@Field singleEntityPackageName = "entity"
@Field singleapiPackageName = "api"
@Field singleVOPackageName = "vo"
@Field singleRepositoryPackageName = "repository"
@Field singleControllerPackageName = "controller"
@Field singleServicePackageName = "service"
@Field singleImplPackageName = "impl"

//need build param
@Field parentPath = ""
@Field haveParentPath = false
@Field haveBusiness = false
@Field apiPath
@Field apiPackageName
@Field voPath
@Field voPackageName
@Field entityPath
@Field entityPackageName
@Field repositoryPath
@Field repositoryPackageName
@Field controllerPath
@Field controllerPackageName
@Field servicePath
@Field servicePackageName
@Field implPath
@Field implPackageName
@Field subProjRoot
@Field testProGroovyPath
@Field testControllerPath
@Field testMockPath
@Field testMockPackageName
@Field testPropertiesPath
@Field testI18nPath
@Field testI18nKey
@Field testSpringPath
@Field liquibasePath
/**
 * 模块类型 jpa，neo4j，mongo
 * 目前仅支持jpa代码生成
 */
@Field modelDAOType = 'jpa'
/**
 * 模块名
 */
@Field modelName
/**
 * 模块名包
 */
@Field modelPackageName
/**
 * 模块路径
 */
@Field modelPackagePath
/**
 * 模块资源名称
 */
@Field modelResourceName
/**
 * 业务名
 * 默认业务名等于模块名
 */
@Field businessName
/**
 * 业务表
 */
@Field businessDataTableName
/**
 * 业务路径
 */
@Field projectPackagePath
/**
 * 业务包名
 */
@Field projectPackageName
/**
 * controller名
 */
@Field controllerName
/**
 * service名
 */
@Field serviceName
/**
 * 实现名
 */
@Field implName
/**
 * repository名
 */
@Field repositoryName
/**
 * 接口名
 */
@Field apiName
/**
 * entity名
 */
@Field entityName
/**
 * VO名
 */
@Field voName
/**
 * Configuration名
 */
@Field configurationName
/**
 * properties名
 */
@Field propertiesName

task buildCode
buildCode.doLast {
    initProjectParam()
    mkProcessDir()
    mkProcess()
    initBusinessParam()
    mkBusinessDir()
    mkLiquibase()
    mkJava()
    mkTestDir()
    mkTest()
}

def initProjectParam() {
    def modelParam = project.getProperties().get('model')
    if ("" == modelParam || null == modelParam) {
        throw new Exception("=======================buildCode modelParam like -Pmodel=*** is required | example gradlew buildCode -Pmodel=five -PmodelPackage=four=======================")
    }
    if (!modelParam.toString().startsWith("${projectGenerator.modelStartName}-")) {
        modelParam = "${projectGenerator.modelStartName}-" + modelParam
    }
    haveBusiness = project.getProperties().containsKey('business')
    haveParentPath = project.getProperties().containsKey('parentPath')
    if (haveParentPath) {
        this.parentPath = project.getProperties().get('parentPath')
        if (!this.parentPath.toString().endsWith("/")) {
            throw new Exception("=======================parentPath must end with /=======================")
        }
        if (this.parentPath == "/") {
            throw new Exception("=======================parentPath is a error path=======================")
        }
    }
    this.modelName = toLowerCase(modelParam)
    parseModelPackage()
    parseBusinessPackage()
    this.subProjRoot = "${rootProject.projectDir}/subprojects/" + (haveParentPath ? parentPath + modelName : modelName)
    this.projectPackagePath = "${subProjRoot}/src/main/java/com/proper/enterprise/${projectGenerator.artifact}/${modelPackagePath}" + (haveBusiness ? "/${businessName}" : "")
    this.projectPackageName = "${rootPackageName}.${projectGenerator.artifact}.${modelPackageName}" + (haveBusiness ? ".${businessName}" : "")
    this.testProGroovyPath = "$subProjRoot/src/test/groovy/com/proper/enterprise/${projectGenerator.artifact}/${modelPackagePath}" + (haveBusiness ? "/${businessName}" : "")
    this.testPropertiesPath = "$subProjRoot/src/test/resources/conf/$modelPackagePath"
    this.testI18nPath = "$subProjRoot/src/test/resources/i18n/$modelPackagePath"
    this.testSpringPath = "$subProjRoot/src/test/resources/spring/$modelPackagePath"
    this.liquibasePath = "$subProjRoot/src/main/resources/liquibase/${projectGenerator.version}/changelogs/"+("pep"==projectGenerator.modelStartName?"":projectGenerator.modelStartName)
}

def parseModelPackage() {
    this.modelPackageName = (this.modelName - "${projectGenerator.modelStartName}-").replace('-', '.')
    this.modelPackagePath = (this.modelName - "${projectGenerator.modelStartName}-").replace('-', '/')
    this.modelResourceName = this.modelName - "${projectGenerator.modelStartName}-"
    this.testI18nKey = "${modelResourceName}.test.max.error"
}

def parseBusinessPackage() {
    def businessParam = project.getProperties().get('business')
    if (!haveBusiness) {
        businessParam = this.modelPackageName
        if (this.modelPackageName.toString().contains(".")) {
            String[] args = this.modelPackageName.toString().split("\\.")
            businessParam = args.last()
        }
    }
    this.businessName = toLowerCase(businessParam)
}

def initBusinessParam() {
    this.apiPath = projectPackagePath + "/${singleapiPackageName}"
    this.apiPackageName = "${projectPackageName}.${singleapiPackageName}"
    this.voPath = projectPackagePath + "/${singleVOPackageName}"
    this.voPackageName = "${projectPackageName}.${singleVOPackageName}"
    this.entityPath = projectPackagePath + "/${singleEntityPackageName}"
    this.entityPackageName = "${projectPackageName}.${singleEntityPackageName}"
    this.repositoryPath = projectPackagePath + "/${singleRepositoryPackageName}"
    this.repositoryPackageName = "${projectPackageName}.${singleRepositoryPackageName}"
    this.servicePath = projectPackagePath + "/${singleServicePackageName}"
    this.servicePackageName = "${projectPackageName}.${singleServicePackageName}"
    this.implPath = projectPackagePath + "/${singleServicePackageName}/${singleImplPackageName}"
    this.implPackageName = "${projectPackageName}.${singleServicePackageName}.${singleImplPackageName}"
    this.controllerPath = projectPackagePath + "/${singleControllerPackageName}"
    this.controllerPackageName = "${projectPackageName}.${singleControllerPackageName}"

    this.controllerName = "jpa" == this.modelDAOType ? toFirstUpperCase("${businessName}Controller") : ""
    this.serviceName = "jpa" == this.modelDAOType ? toFirstUpperCase("${businessName}Service") : ""
    this.implName = "jpa" == this.modelDAOType ? toFirstUpperCase("${businessName}ServiceImpl") : ""
    this.repositoryName = "jpa" == this.modelDAOType ? toFirstUpperCase("${businessName}Repository") : ""
    this.entityName = "jpa" == this.modelDAOType ? toFirstUpperCase("${businessName}Entity") : ""
    this.apiName = toFirstUpperCase("${businessName}")
    this.voName = toFirstUpperCase("${businessName}VO")
    this.configurationName= toFirstUpperCase("${businessName}Configuration")
    this.propertiesName= toFirstUpperCase("${businessName}Properties")
    this.testControllerPath = "${testProGroovyPath}/${singleControllerPackageName}"
    this.testMockPath = "${testProGroovyPath}/mock"
    this.testMockPackageName = "${projectPackageName}.mock"
    this.businessDataTableName = "${projectGenerator.modelStartName}_${(this.modelName - "${projectGenerator.modelStartName}-").replace('-', '_')}" + (haveBusiness ? "_${businessName.toString().toUpperCase()}" : "")
}

def mkProcessDir() {
    mkdir(subProjRoot)
    mkdir("$subProjRoot/src/main/java/com/proper/enterprise/${projectGenerator.artifact}")
    mkdir("$subProjRoot/src/main/resources")
    mkdir(testProGroovyPath)
    mkdir("$subProjRoot/src/test/resources")
//    mkdir(testPropertiesPath)
//    mkdir(testSpringPath)
    mkdir(testI18nPath)
    mkdir(liquibasePath)
}

def mkBusinessDir() {
    mkdir(voPath)
    //mkdir(apiPath)
    mkdir(entityPath)
    mkdir(repositoryPath)
    mkdir(servicePath)
    mkdir(implPath)
    mkdir(controllerPath)
}

def mkTestDir() {
    mkdir(testControllerPath)
}

def mkProcess() {
    file("$subProjRoot/${modelName}.gradle").withWriter {
        it.write("""dependencies {

        implementation project(':pep-core-jpa')

    testImplementation project(':pep-auth-common-jpa'),
                       project(':pep-test')

}""")
    }
    file("$subProjRoot/README.md").withWriter {
        it.write("""$modelName
${"=" * modelName.length()}
Proper Enterprise Platform""")
    }
}

def mkJava() {
    //mkApi()
    mkVO()
    mkEntity()
    mkRepository()
    mkService()
    mkImpl()
    mkController()
}

def mkLiquibase() {

    //dml
    file("$liquibasePath/changelog-dml-${modelResourceName}.xml").withWriter(charset) {
        it.write("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n" +
            "<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog\"\n" +
            "                   xmlns:ext=\"http://www.liquibase.org/xml/ns/dbchangelog-ext\"\n" +
            "                   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n" +
            "                   xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd\">\n" +
            "    <!--数据变更-->\n" +
            "    <!--初始化OOPSEARCH 数据-->\n" +
            "    <changeSet author=\"generator(generator)\" id=\"${modelResourceName}_generator_dml_oopsearch_init\">\n" +
            "        <insert tableName=\"PEP_OOPSEARCH_CONFIG\">\n" +
            "            <column name=\"ID\" value=\"${modelResourceName}_test\"/>\n" +
            "            <column name=\"CREATE_TIME\" value=\"2017-02-20 00:00:00\"/>\n" +
            "            <column name=\"CREATE_USER_ID\" value=\"PEP\"/>\n" +
            "            <column name=\"LAST_MODIFY_TIME\" value=\"2017-02-20 00:00:00\"/>\n" +
            "            <column name=\"LAST_MODIFY_USER_ID\" value=\"PEP\"/>\n" +
            "            <!--别名 与controller中的参数对应-->\n" +
            "            <column name=\"COLUMN_ALIAS\" value=\"test\"/>\n" +
            "            <!--字段的描述(展示于回显)-->\n" +
            "            <column name=\"COLUMN_DESC\" value=\"测试\"/>\n" +
            "            <column name=\"COLUMN_TYPE\" value=\"int\"/>\n" +
            "            <!--模块名称需要提前与前台确认-->\n" +
            "            <column name=\"MODULE_NAME\" value=\"${modelResourceName}\"/>\n" +
            "            <!--在表中的列名称-->\n" +
            "            <column name=\"SEARCH_COLUMN\" value=\"test\"/>\n" +
            "            <!--表名-->\n" +
            "            <column name=\"TABLE_NAME\" value=\"${businessDataTableName}\"/>\n" +
            "            <!--controller对应的url(支持restful)-->\n" +
            "            <column name=\"URL\" value=\"/${modelResourceName}\"/>\n" +
            "        </insert>\n" +
            "    </changeSet>\n" +
            "</databaseChangeLog>")
    }
    file("$liquibasePath/changelog-ddl-${modelResourceName}.xml").withWriter(charset) {
        it.write("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n" +
            "<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog\"\n" +
            "                   xmlns:ext=\"http://www.liquibase.org/xml/ns/dbchangelog-ext\"\n" +
            "                   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n" +
            "                   xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd\">\n" +
            "    <changeSet author=\"generator (generated)\" id=\"${modelResourceName}_generator_ddl_init\">\n" +
            "        <createTable tableName=\"${businessDataTableName.toString().toUpperCase()}\">\n" +
            "            <column name=\"ID\" type=\"VARCHAR(255)\">\n" +
            "                <constraints nullable=\"false\"/>\n" +
            "            </column>\n" +
            "            <column defaultValue=\"2017-02-20 00:00:00\" name=\"CREATE_TIME\" type=\"VARCHAR(255)\">\n" +
            "                <constraints nullable=\"false\"/>\n" +
            "            </column>\n" +
            "            <column defaultValue=\"PEP\" name=\"CREATE_USER_ID\" type=\"VARCHAR(255)\">\n" +
            "                <constraints nullable=\"false\"/>\n" +
            "            </column>\n" +
            "            <column defaultValue=\"2017-02-20 00:00:00\" name=\"LAST_MODIFY_TIME\" type=\"VARCHAR(255)\">\n" +
            "                <constraints nullable=\"false\"/>\n" +
            "            </column>\n" +
            "            <column defaultValue=\"PEP\" name=\"LAST_MODIFY_USER_ID\" type=\"VARCHAR(255)\">\n" +
            "                <constraints nullable=\"false\"/>\n" +
            "            </column>\n" +
            "            <column defaultValue=\"Y\" name=\"ENABLE\" type=\"CHAR(1)\">\n" +
            "                <constraints nullable=\"false\"/>\n" +
            "            </column>\n" +
            "            <column name=\"TEST\" type=\"INT(10)\"/>\n" +
            "        </createTable>\n" +
            "        <addPrimaryKey tableName=\"${businessDataTableName.toString().toUpperCase()}\" columnNames=\"ID\" constraintName=\"PK_${businessDataTableName.toString().toUpperCase()}\"/>\n" +
            "    </changeSet>\n" +
            "</databaseChangeLog>")
    }
}

def mkTest() {
    mkControllerTest()
    mkResourceTest()
    mkConfiguration()
    mkProperties()
}

def mkControllerTest() {
    if ("jpa" == modelDAOType) {
        mkJpaControllerTest()
    }
}

def  mkConfiguration(){
    file("${testProGroovyPath}/${configurationName}.java").withWriter(charset) {
        it.write("""package ${projectPackageName};

import org.springframework.context.annotation.Configuration;

/**
 * 统一命名{模块名}+Configuration.java
 * 在test环境有效 若要使用迁移到 java目录下即可
 * 对于bean的配置声明等在Configuration中完成
 */
@Configuration
public class ${configurationName} {
}""")
    }
}

def  mkProperties(){
    file("${testProGroovyPath}/${propertiesName}.java").withWriter(charset) {
        it.write("""package ${projectPackageName};

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

/**
 * 统一命名{模块名}+Properties.java
 * 此配置在test环境有效 若要使用迁移到 java目录下即可
 *
 * 规范
 * prefix中的{项目名}.{模块名}为配置的命名空间
 * 若需要添加配置仅需在此文件下新建成员变量及对应的get,set方法即可
 * 要求javaDoc完整，若有默认值则给成员变量添加默认值即可
 * 驼峰命名
 *
 * 满足规范且编译后 会在配置文件中查看到对于此配置的描述及默认值
 */
@Component
@ConfigurationProperties(prefix = "${projectGenerator.modelStartName}.${businessName}")
public class ${propertiesName} {
}""")
    }
}


def mkResourceTest() {
//    file("$testPropertiesPath/${modelResourceName}.properties").withWriter(charset) {
//        it.write("#test 中的配置文件仅在单元测试环境中有效，若想全局代码有效将单元测试中的源文件及目录一同粘贴到main下resources")
//    }
//    file("$testSpringPath/applicationContext-${modelResourceName}.xml").withWriter(charset) {
//        it.write("""<?xml version="1.0" encoding="UTF-8"?>
//<beans xmlns="http://www.springframework.org/schema/beans"
//       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
//       xmlns:context="http://www.springframework.org/schema/context"
//       xsi:schemaLocation="http://www.springframework.org/schema/beans
//                           http://www.springframework.org/schema/beans/spring-beans.xsd
//                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">
//    <beans>
//        <context:property-placeholder ignore-unresolvable="true"
//                                      location="classpath:conf/${modelPackagePath}/${modelResourceName}.properties"/>
//    </beans>
//
//</beans>""")
//    }
    file("$testI18nPath/${modelResourceName}-i18n.properties").withWriter(charset) {
        it.write("""#test 中的配置文件仅在单元测试环境中有效，若想全局代码有效将单元测试中的源文件及目录一同粘贴到main下resources
${testI18nKey}=test max value 100""")
    }

    file("$testI18nPath/${modelResourceName}-i18n_zh_CN.properties").withWriter(charset) {
        it.write("""#test 中的配置文件仅在单元测试环境中有效，若想全局代码有效将单元测试中的源文件及目录一同粘贴到main下resources
${testI18nKey}=test 不能超过100""")
    }
}

def mkController() {
    if ("jpa" == modelDAOType) {
        mkJpaController()
    }
}

def mkService() {
    if ("jpa" == modelDAOType) {
        mkJpaService()
    }
}

def mkImpl() {
    if ("jpa" == modelDAOType) {
        mkJpaImpl()
    }
}

def mkRepository() {
    if ("jpa" == modelDAOType) {
        mkJpaRepository()
    }
}


def mkApi() {
    file("${apiPath}/${apiName}.java").withWriter(charset) {
        it.write("""package ${apiPackageName};

import com.proper.enterprise.platform.core.api.IBase;

public interface ${apiName} extends IBase {

    Integer getTest();

    ${apiName} setTest(Integer test);
}""")
    }
}

def mkEntity() {
    if ("jpa" == modelDAOType) {
        mkJpaEntity()
    }
}

def mkVO() {
    file("${voPath}/${voName}.java").withWriter(charset) {
        it.write("""package ${voPackageName};

import com.fasterxml.jackson.annotation.JsonView;
import com.proper.enterprise.platform.core.utils.JSONUtil;
import com.proper.enterprise.platform.core.pojo.BaseVO;
import com.proper.enterprise.platform.core.view.BaseView;
import io.swagger.annotations.ApiModelProperty;

import javax.validation.constraints.Max;

public class ${voName} extends BaseVO {

    public ${voName}(){}

    public interface Single extends BaseView {}

    @JsonView(Single.class)
    @Max(value = 100, message = "{${testI18nKey}}")
    @ApiModelProperty(name = "‍测试字段")
    private Integer test;

    public Integer getTest() {
        return test;
    }

    public ${voName} setTest(Integer test) {
        this.test = test;
        return this;
    }

    @Override
    public String toString() {
        return JSONUtil.toJSONIgnoreException(this);
    }
}""")
    }
}

//===================================================== jpa ==============================================================
def mkJpaController() {
    file("${controllerPath}/${controllerName}.java").withWriter(charset) {
        it.write("""package ${controllerPackageName};

import com.fasterxml.jackson.annotation.JsonView;
import com.proper.enterprise.platform.core.controller.BaseController;
import com.proper.enterprise.platform.core.entity.DataTrunk;
import ${voPackageName}.${voName};
import ${servicePackageName}.${serviceName};
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiImplicitParams;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/${businessName}")
@Api(tags = "/${businessName}")
public class ${controllerName} extends BaseController {

    @Autowired
    private ${serviceName} ${toFirstLowerCase(serviceName)};

    @PostMapping
    @JsonView(${voName}.Single.class)
    @ApiOperation("‍新增${businessName}")
    public ResponseEntity<${voName}> post(@RequestBody ${voName} ${toFirstLowerCase(voName)}) {
        return responseOfPost(${toFirstLowerCase(serviceName)}.save(${toFirstLowerCase(voName)}));
    }

    @DeleteMapping
    @ApiOperation("‍删除${businessName}")
    public ResponseEntity delete(@RequestParam String id) {
        return responseOfDelete(${toFirstLowerCase(serviceName)}.deleteById(id));
    }

    @PutMapping
    @JsonView(${voName}.Single.class)
    @ApiOperation("‍修改${businessName}")
    public ResponseEntity<${voName}> put(@RequestBody ${voName} ${toFirstLowerCase(voName)}) {
        return responseOfPut(${toFirstLowerCase(serviceName)}.update(${toFirstLowerCase(voName)}));
    }

    @GetMapping
    @JsonView(${voName}.Single.class)
    @ApiOperation("‍查询${businessName}列表")
    @ApiImplicitParams(value = {
        @ApiImplicitParam(name = "pageNo", value = "‍页码", required = true, paramType = "query", dataType = "int"),
        @ApiImplicitParam(name = "pageSize", value = "‍每页条数", required = true, paramType = "query", dataType = "int")
    })
    public ResponseEntity<DataTrunk> get(Integer test) {
        return isPageSearch() ? responseOfGet(${toFirstLowerCase(serviceName)}.findAll(test, getPageRequest()))
            : responseOfGet(new DataTrunk<>(${toFirstLowerCase(serviceName)}.findAll(test)));
    }
}""")
    }
}

def mkJpaControllerTest() {
    file("${testControllerPath}/${controllerName}Test.groovy").withWriter(charset) {
        it.write("""package ${controllerPackageName}

import com.proper.enterprise.platform.core.i18n.I18NUtil
import org.junit.Test
import org.springframework.http.HttpStatus
import com.proper.enterprise.platform.core.entity.DataTrunk
import ${voPackageName}.${voName}
import com.proper.enterprise.platform.test.AbstractJPATest
import com.proper.enterprise.platform.test.utils.JSONUtil

class ${controllerName}Test extends AbstractJPATest {

    private static final URL = "/${businessName}"

    @Test
    void "post"() {
        mockUser('test1', 't1', 'pwd')
        assert I18NUtil.getMessage("${testI18nKey}") == post(URL, JSONUtil.toJSON(new ${voName}().setTest(999)), HttpStatus.INTERNAL_SERVER_ERROR).getResponse().getContentAsString()
        ${voName} result = resOfPost(URL, new ${voName}())
        expect:
        assert null != result.getId()
    }

    @Test
    void "delete"() {
        mockUser('test1', 't1', 'pwd')
        delete(URL + "?id=1", HttpStatus.NOT_FOUND)
        ${voName} result = resOfPost(URL, new ${voName}())
        delete(URL + "?id=" + result.getId(), HttpStatus.NO_CONTENT)
    }

    @Test
    void "put"() {
        mockUser('test1', 't1', 'pwd')
        ${voName} vo = new ${voName}()
        vo.setTest(1)
        ${voName} result = resOfPost(URL, vo)
        result.setTest(2)
        ${voName} result2 = JSONUtil.parse(put(URL, JSONUtil.toJSON(result), HttpStatus.OK)
            .getResponse().getContentAsString(), ${voName}.class)
        expect:
        assert 2 == result2.getTest()
    }

    @Test
    void "get"() {
        mockUser('test1', 't1', 'pwd')
        ${voName} vo1 = new ${voName}().setTest(1)
        ${voName} vo2 = new ${voName}().setTest(2)
        ${voName} vo3 = new ${voName}().setTest(3)
        resOfPost(URL, vo1)
        resOfPost(URL, vo2)
        resOfPost(URL, vo3)
        DataTrunk<${voName}> dataTrunk = JSONUtil.parse(get(URL, HttpStatus.OK).getResponse().getContentAsString(), DataTrunk)
        DataTrunk<${voName}> page = JSONUtil.parse(get(URL + "?pageNo=1&pageSize=1", HttpStatus.OK).getResponse().getContentAsString(), DataTrunk)
        DataTrunk<${voName}> queryTest3 = JSONUtil.parse(get(URL + "?test=3", HttpStatus.OK).getResponse().getContentAsString(), DataTrunk)

        expect:
        assert 3 == dataTrunk.getCount()
        assert 3 == page.count
        assert 1 == page.getData().size()
        assert 1 == queryTest3.getCount()
        assert 3 == queryTest3.getData()[0].test
    }
}""")
    }
}

def mkJpaService() {
    file("${servicePath}/${serviceName}.java").withWriter(charset) {
        it.write("""package ${servicePackageName};

import ${voPackageName}.${voName};
import com.proper.enterprise.platform.core.entity.DataTrunk;
import org.springframework.data.domain.Pageable;
import org.springframework.validation.annotation.Validated;

import javax.validation.Valid;
import java.util.Collection;

@Validated
public interface ${serviceName} {

    /**
     * 保存
     *
     * @param ${toFirstLowerCase(voName)} vo
     * @return 保存后的vo
     */
    ${voName} save(@Valid ${voName} ${toFirstLowerCase(voName)});

    /**
     * 根据Id删除
     *
     * @param id id
     * @return true删除成功  false未删除
     */
    boolean deleteById(String id);

    /**
     * 单表修改
     *
     * @param ${toFirstLowerCase(voName)} vo
     * @return 修改后的vo
     */
    ${voName} update(${voName} ${toFirstLowerCase(voName)});

    /**
     * 查询
     * @param test 查询参数
     * @return vo集合
     */
    Collection<${voName}> findAll(Integer test);

    /**
     * 分页查询
     *
     * @param test 查询参数
     * @param pageable 分页参数
     * @return 分页VO对象
     */
    DataTrunk<${voName}> findAll(Integer test, Pageable pageable);

}""")
    }
}

def mkJpaImpl() {
    file("${implPath}/${implName}.java").withWriter(charset) {
        it.write("""package ${implPackageName};

import com.proper.enterprise.platform.core.entity.DataTrunk;
import com.proper.enterprise.platform.core.utils.BeanUtil;
import ${entityPackageName}.${entityName};
import ${voPackageName}.${voName};
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import ${repositoryPackageName}.${repositoryName};
import ${servicePackageName}.${serviceName};

import java.util.Collection;

@Service
public class ${implName} implements ${serviceName} {

    private ${repositoryName} ${toFirstLowerCase(businessName)}Repository;

    @Autowired
    public ${implName}(${repositoryName} ${toFirstLowerCase(businessName)}Repository) {
        this.${toFirstLowerCase(businessName)}Repository = ${toFirstLowerCase(businessName)}Repository;
    }

    @Override
    public ${voName} save(${voName} ${toFirstLowerCase(voName)}) {
        ${entityName} entity = BeanUtil.convert(${toFirstLowerCase(voName)}, ${entityName}.class);
        return BeanUtil.convert(${toFirstLowerCase(businessName)}Repository.save(entity), ${voName}.class);
    }

    @Override
    public boolean deleteById(String id) {
        return ${toFirstLowerCase(businessName)}Repository.delete(id);
    }

    @Override
    public ${voName} update(${voName} ${toFirstLowerCase(voName)}) {
        ${entityName} entity = BeanUtil.convert(${toFirstLowerCase(voName)}, ${entityName}.class);
        return BeanUtil.convert(${toFirstLowerCase(businessName)}Repository.updateForSelective(entity), ${voName}.class);
    }

    @Override
    public Collection<${voName}> findAll(Integer test) {
        if (null == test) {
            return BeanUtil.convert(${toFirstLowerCase(businessName)}Repository.findAll(), ${voName}.class);
        }
        return BeanUtil.convert(${toFirstLowerCase(businessName)}Repository.findAllByTestOrderByTestDesc(test), ${voName}.class);
    }

    @Override
    public DataTrunk<${voName}> findAll(Integer test, Pageable pageable) {
        return BeanUtil.convert(${toFirstLowerCase(businessName)}Repository.findAll(test, pageable), ${voName}.class);
    }

}""")
    }
}

def mkJpaEntity() {
    file("${entityPath}/${entityName}.java").withWriter(charset) {
        it.write("""package ${entityPackageName};

import com.proper.enterprise.platform.core.jpa.entity.BaseEntity;
import com.proper.enterprise.platform.core.utils.JSONUtil;
import javax.persistence.*;

@Entity
@Table(name = "${businessDataTableName.toString().toUpperCase()}")
public class ${entityName} extends BaseEntity {

    public ${entityName}(){}

    @Column
    private Integer test;

    public Integer getTest() {
        return test;
    }

    public ${entityName} setTest(Integer test) {
        this.test = test;
        return this;
    }

    @Override
    public String toString() {
        return JSONUtil.toJSONIgnoreException(this);
    }
}""")
    }
}

def mkJpaRepository() {
    file("${repositoryPath}/${repositoryName}.java").withWriter(charset) {
        it.write("""package ${repositoryPackageName};

import ${entityPackageName}.${entityName};
import com.proper.enterprise.platform.core.jpa.repository.BaseJpaRepository;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;

public interface ${repositoryName} extends BaseJpaRepository<${entityName}, String> {

    /**
     * 根据修改时间倒叙查询列表
     * 不传参数 spring-data风格的查询会返回空
     * @param test 查询参数
     * @return 实体集合
     */
    List<${entityName}> findAllByTestOrderByTestDesc(@Param("test") Integer test);

    /**
     * 根据修改时间倒叙分页查询
     * 建议优先使用 spring-data风格的查询 若查询的条件过多 spring-data风格写起来过于复杂 考虑使用@Query实现查询
     * @param test     查询参数
     * @param pageable 分页参数
     * @return 分页实体集合
     */
    @Query("select t from ${entityName} t where (t.test=:test or :test is null )")
    Page<${entityName}> findAll(@Param("test") Integer test, Pageable pageable);

}""")
    }
}

static def toFirstUpperCase(str) {
    return str.substring(0, 1).toUpperCase() + str.substring(1)
}

static def toFirstLowerCase(str) {
    return str.substring(0, 1).toLowerCase() + str.substring(1)
}

static def toLowerCase(str) {
    return str.toLowerCase()
}

